name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Frontend (React Client) Build and Test
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      continue-on-error: true
      
    - name: Run type checking
      run: npm run type-check
      continue-on-error: true
      
    - name: Run tests
      run: npm run test
      continue-on-error: true
      
    - name: Build application
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: client-build-${{ matrix.node-version }}
        path: client/dist/
        retention-days: 7

  # Java Microservices Build and Test
  java-services:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [UserService, HomeworkService/HomeworkService, ScheduleService]
        java-version: [17, 21]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run tests for ${{ matrix.service }}
      run: |
        cd ${{ matrix.service }}
        ./mvnw clean test
      continue-on-error: true
      
    - name: Build ${{ matrix.service }}
      run: |
        cd ${{ matrix.service }}
        ./mvnw clean package -DskipTests
        
    - name: Upload JAR artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.service }}-jar-jdk${{ matrix.java-version }}
        path: ${{ matrix.service }}/target/*.jar
        retention-days: 7

  # Node.js Services Build and Test
  nodejs-services:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [ClassroomService, FileService]
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: ${{ matrix.service }}/package-lock.json
        
    - name: Install dependencies for ${{ matrix.service }}
      run: |
        cd ${{ matrix.service }}
        npm ci
        
    - name: Run linting for ${{ matrix.service }}
      run: |
        cd ${{ matrix.service }}
        npm run lint || echo "Linting not configured"
      continue-on-error: true
      
    - name: Run tests for ${{ matrix.service }}
      run: |
        cd ${{ matrix.service }}
        npm test || echo "Tests not configured"
      continue-on-error: true
      
    - name: Upload service artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.service }}-${{ matrix.node-version }}
        path: ${{ matrix.service }}/
        retention-days: 7

  # Security and Code Quality Checks
  security-scan:
    runs-on: ubuntu-latest
    needs: [frontend-build, java-services, nodejs-services]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Integration Tests
  integration-tests:
    runs-on: ubuntu-latest
    needs: [frontend-build, java-services, nodejs-services]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        # Add your integration test commands here
        # For example, starting services and running end-to-end tests
      env:
        DATABASE_URL: mysql://root:rootpassword@localhost:3306/testdb
        REDIS_URL: redis://localhost:6379

  # Build Summary and Notifications
  build-summary:
    runs-on: ubuntu-latest
    needs: [frontend-build, java-services, nodejs-services, security-scan, integration-tests]
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Java Services | ${{ needs.java-services.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js Services | ${{ needs.nodejs-services.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Build failed! Check the logs for details."
        echo "Failed jobs: ${{ toJson(needs) }}"