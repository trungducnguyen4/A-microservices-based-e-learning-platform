name: Development Deployment

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  ENVIRONMENT: development
  REGISTRY: ghcr.io

jobs:
  # Quick Build and Test for Development
  quick-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Quick frontend build
      run: |
        cd client
        npm ci
        npm run build
        
    - name: Quick Java services build
      run: |
        services=("UserService" "HomeworkService/HomeworkService" "ScheduleService")
        for service in "${services[@]}"; do
          echo "Building $service..."
          cd "$service"
          ./mvnw clean compile -DskipTests -q
          cd - > /dev/null
        done
        
    - name: Quick Node.js services check
      run: |
        services=("ClassroomService" "FileService")
        for service in "${services[@]}"; do
          echo "Checking $service..."
          cd "$service"
          npm ci
          cd - > /dev/null
        done

  # Deploy to Development Environment
  deploy-dev:
    runs-on: ubuntu-latest
    needs: quick-build
    if: success() || github.event.inputs.force_deploy == 'true'
    environment:
      name: development
      url: https://dev.e-learning-platform.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to development
      run: |
        echo "ğŸš€ Deploying to development environment..."
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        
        # Add your deployment commands here
        # Example: kubectl apply -f k8s/dev/ or docker-compose up -d
        
        echo "âœ… Development deployment completed!"
        
    - name: Run smoke tests
      run: |
        echo "ğŸ§ª Running smoke tests..."
        
        # Add smoke test commands here
        # Example: curl health endpoints, run basic API tests
        
        sleep 30  # Wait for services to start
        
        # Test endpoints (replace with actual URLs)
        endpoints=(
          "http://dev-api.example.com/users/health"
          "http://dev-api.example.com/homework/health"
          "http://dev-api.example.com/schedule/health"
          "http://dev-frontend.example.com/health"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing $endpoint..."
          # curl -f "$endpoint" || echo "âš ï¸  $endpoint not responding"
        done
        
        echo "âœ… Smoke tests completed!"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Development deployment successful!"
          echo "ğŸŒ Frontend: https://dev.e-learning-platform.example.com"
          echo "ğŸ”§ API: https://dev-api.e-learning-platform.example.com"
        else
          echo "âŒ Development deployment failed!"
        fi

  # Development Database Migration
  db-migration-dev:
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: success()
    environment:
      name: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run database migrations
      run: |
        echo "ğŸ—ƒï¸  Running database migrations for development..."
        
        # Add migration commands here
        # Example: Run Flyway migrations, Liquibase updates, etc.
        
        echo "âœ… Database migrations completed!"

  # Clean up old development deployments
  cleanup-dev:
    runs-on: ubuntu-latest
    needs: [deploy-dev, db-migration-dev]
    if: always()
    
    steps:
    - name: Clean up old deployments
      run: |
        echo "ğŸ§¹ Cleaning up old development deployments..."
        
        # Add cleanup commands here
        # Example: Remove old Docker images, clean up old Kubernetes deployments
        
        echo "âœ… Cleanup completed!"