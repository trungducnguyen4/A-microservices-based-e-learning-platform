name: Production Deployment

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean

env:
  ENVIRONMENT: production
  REGISTRY: ghcr.io

jobs:
  # Pre-deployment validation
  pre-deployment-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        
    - name: Validate tag format
      run: |
        if [[ "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] || [[ "${{ github.event.inputs.tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚úÖ Valid version tag"
        else
          echo "‚ùå Invalid version tag format. Expected: v1.0.0"
          exit 1
        fi
        
    - name: Check changelog
      run: |
        if [ -f "CHANGELOG.md" ]; then
          version="${{ github.ref_name || github.event.inputs.tag }}"
          if grep -q "$version" CHANGELOG.md; then
            echo "‚úÖ Changelog entry found for $version"
          else
            echo "‚ö†Ô∏è  No changelog entry found for $version"
          fi
        else
          echo "‚ö†Ô∏è  No CHANGELOG.md found"
        fi

  # Full test suite for production
  full-test-suite:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event.inputs.skip_tests != 'true'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Run comprehensive tests
      run: |
        echo "üß™ Running comprehensive test suite..."
        
        # Frontend tests
        cd client
        npm ci
        npm run test -- --coverage --watchAll=false
        npm run build
        cd ..
        
        # Java service tests
        services=("UserService" "HomeworkService/HomeworkService" "ScheduleService")
        for service in "${services[@]}"; do
          echo "Testing $service..."
          cd "$service"
          ./mvnw clean test
          cd - > /dev/null
        done
        
        # Node.js service tests
        services=("ClassroomService" "FileService")
        for service in "${services[@]}"; do
          echo "Testing $service..."
          cd "$service"
          npm ci
          npm test || echo "No tests configured for $service"
          cd - > /dev/null
        done
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-production
        path: |
          client/coverage/
          **/target/surefire-reports/
        retention-days: 30

  # Security audit for production
  security-audit:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        
    - name: Run security audit
      run: |
        echo "üîí Running security audit..."
        
        # NPM audit for client and Node.js services
        services=("client" "ClassroomService" "FileService")
        for service in "${services[@]}"; do
          echo "Auditing $service..."
          cd "$service"
          npm audit --audit-level moderate
          cd - > /dev/null
        done
        
        # Maven security check for Java services
        services=("UserService" "HomeworkService/HomeworkService" "ScheduleService")
        for service in "${services[@]}"; do
          echo "Security check for $service..."
          cd "$service"
          ./mvnw org.owasp:dependency-check-maven:check || echo "Dependency check completed with warnings"
          cd - > /dev/null
        done

  # Build production images
  build-production-images:
    runs-on: ubuntu-latest
    needs: [full-test-suite, security-audit]
    if: always() && (needs.full-test-suite.result == 'success' || needs.full-test-suite.result == 'skipped') && needs.security-audit.result == 'success'
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        service: 
          - { name: "client", path: "client" }
          - { name: "UserService", path: "UserService" }
          - { name: "HomeworkService", path: "HomeworkService/HomeworkService" }
          - { name: "ScheduleService", path: "ScheduleService" }
          - { name: "ClassroomService", path: "ClassroomService" }
          - { name: "FileService", path: "FileService" }
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service.name }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest
          
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and push production image
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.service.path }}
        file: ./${{ matrix.service.path }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # Deploy to production
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-production-images
    environment:
      name: production
      url: https://e-learning-platform.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        
    - name: Deploy to production
      run: |
        echo "üöÄ Deploying to production environment..."
        echo "Version: ${{ github.ref_name || github.event.inputs.tag }}"
        echo "Commit: ${{ github.sha }}"
        
        # Add your production deployment commands here
        # Example: kubectl apply -f k8s/prod/ or helm upgrade
        
        echo "‚úÖ Production deployment initiated!"
        
    - name: Database migration
      run: |
        echo "üóÉÔ∏è  Running production database migrations..."
        
        # Add production migration commands here
        # Ensure migrations are backward compatible and safe
        
        echo "‚úÖ Database migrations completed!"
        
    - name: Health checks
      run: |
        echo "üè• Running production health checks..."
        
        sleep 60  # Wait for services to fully start
        
        # Add production health check commands here
        endpoints=(
          "https://api.e-learning-platform.example.com/users/health"
          "https://api.e-learning-platform.example.com/homework/health"
          "https://api.e-learning-platform.example.com/schedule/health"
          "https://e-learning-platform.example.com/health"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Checking $endpoint..."
          # curl -f "$endpoint" || (echo "‚ùå $endpoint failed" && exit 1)
        done
        
        echo "‚úÖ All health checks passed!"

  # Post-deployment verification
  post-deployment:
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
    - name: Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.tag }}
        release_name: Release ${{ github.ref_name || github.event.inputs.tag }}
        body: |
          ## Changes in this Release
          - Check CHANGELOG.md for detailed changes
          
          ## Deployment Information
          - **Environment**: Production
          - **Deployed at**: ${{ steps.date.outputs.date }}
          - **Commit**: ${{ github.sha }}
        draft: false
        prerelease: false
        
    - name: Notify team
      run: |
        echo "üì¢ Production deployment completed successfully!"
        echo "üåê Application URL: https://e-learning-platform.example.com"
        echo "üìä Monitoring: Add your monitoring links here"
        echo "üìö Documentation: Add your docs links here"

  # Rollback plan (manual trigger)
  rollback:
    runs-on: ubuntu-latest
    if: failure()
    environment:
      name: production
    
    steps:
    - name: Rollback deployment
      run: |
        echo "üîÑ Initiating rollback procedure..."
        
        # Add rollback commands here
        # Example: kubectl rollout undo deployment, helm rollback
        
        echo "‚ö†Ô∏è  Rollback completed. Please verify system status."