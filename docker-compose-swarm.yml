version: "3.9"

x-restart: &restart_policy
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 30s

# Swarm-compliant common env - NO .env file!
x-common-spring: &spring_env
  SPRING_PROFILES_ACTIVE: docker
  SPRING_REDIS_HOST: redis
  SPRING_REDIS_PORT: 6379
  JWT_SECRET: "REPLACE_WITH_LONG_RANDOM_SECRET_MIN_32_CHARS"
  # Database hardcoded for Swarm (use docker secret in production)
  DB_HOST: "elearningplatform.cj6aaa462kbk.ap-southeast-2.rds.amazonaws.com"
  DB_PORT: "3306"
  DB_USER: "admin"
  DB_PASSWORD: "14072004Az!"

services:
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 1
      # Removed: constraint to manager (too risky)
      placement:
        preferences:
          - spread: node.id
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  api-gateway:
    image: trungduc14/api-gateway:latest
    environment:
      <<: *spring_env
      SERVER_PORT: 8888
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8888/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    ports:
      - "8888:8888"
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      update_config:
        order: start-first
        parallelism: 1
        delay: 10s
      placement:
        preferences:
          - spread: node.id

  user-service:
    image: trungduc14/user-service:latest
    environment:
      <<: *spring_env
      SPRING_DATASOURCE_URL: "jdbc:mysql://${DB_HOST}:${DB_PORT}/db_user?useSSL=false&allowPublicKeyRetrieval=true&connectTimeout=30000&socketTimeout=30000"
      SPRING_DATASOURCE_USERNAME: "${DB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SERVER_PORT: 8080
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 1
      placement:
        preferences:
          - spread: node.id

  homework-service:
    image: trungduc14/homework-service:latest
    environment:
      <<: *spring_env
      SPRING_DATASOURCE_URL: "jdbc:mysql://${DB_HOST}:${DB_PORT}/db_homework?useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_USERNAME: "${DB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SERVER_PORT: 8081
      USER_SERVICE_URL: "http://user-service:8080"
      FILE_SERVICE_URL: "http://file-service:5000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  schedule-service:
    image: trungduc14/schedule-service:latest
    environment:
      <<: *spring_env
      SPRING_DATASOURCE_URL: "jdbc:mysql://${DB_HOST}:${DB_PORT}/db_schedule?useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_USERNAME: "${DB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SERVER_PORT: 8082
      USER_SERVICE_URL: "http://user-service:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  admin-service:
    image: trungduc14/admin-service:latest
    environment:
      <<: *spring_env
      SPRING_DATASOURCE_URL: "jdbc:mysql://${DB_HOST}:${DB_PORT}/admin_db?useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_USERNAME: "${DB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SERVER_PORT: 8084
      USER_SERVICE_URL: "http://user-service:8080"
      HOMEWORK_SERVICE_URL: "http://homework-service:8081"
      SCHEDULE_SERVICE_URL: "http://schedule-service:8082"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8084/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  announcement-service:
    image: trungduc14/announcement-service:latest
    environment:
      <<: *spring_env
      SPRING_DATASOURCE_URL: "jdbc:mysql://${DB_HOST}:${DB_PORT}/announcement_db?useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_USERNAME: "${DB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${DB_PASSWORD}"
      SERVER_PORT: 8090
      USER_SERVICE_URL: "http://user-service:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  classroom-service:
    image: trungduc14/classroom-service:latest
    environment:
      NODE_ENV: production
      PORT: 4000
      DB_HOST: "elearningplatform.cj6aaa462kbk.ap-southeast-2.rds.amazonaws.com"
      DB_PORT: "3306"
      DB_NAME: "classroom_db"
      DB_USER: "admin"
      DB_PASSWORD: "14072004Az!"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: "REPLACE_WITH_LONG_RANDOM_SECRET_MIN_32_CHARS"
      USER_SERVICE_URL: "http://user-service:8080"
      LIVEKIT_URL: "wss://elearning-microservice-98bdertb.livekit.cloud"
      LIVEKIT_API_KEY: "APIw58QnxLKZhHz"
      LIVEKIT_API_SECRET: "efMRFX9tmBWDrGUkvO9WKp3jh2pVJ6UlVWXp3gJZ3rB"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  file-service:
    image: trungduc14/file-service:latest
    environment:
      NODE_ENV: production
      PORT: 5000
      DB_HOST: "elearningplatform.cj6aaa462kbk.ap-southeast-2.rds.amazonaws.com"
      DB_PORT: "3306"
      DB_NAME: "e_learning"
      DB_USER: "admin"
      DB_PASSWORD: "14072004Az!"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: "your-very-secure-jwt-secret-key-here"
      UPLOAD_PATH: /app/uploads
      MAX_FILE_SIZE: "10485760"
    volumes:
      - file_uploads:/app/uploads
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  notification-service:
    image: trungduc14/notification-service:latest
    environment:
      NODE_ENV: production
      PORT: 5001
      DB_HOST: "elearningplatform.cj6aaa462kbk.ap-southeast-2.rds.amazonaws.com"
      DB_PORT: "3306"
      DB_NAME: "notification_db"
      DB_USER: "admin"
      DB_PASSWORD: "14072004Az!"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: "REPLACE_WITH_LONG_RANDOM_SECRET_MIN_32_CHARS"
      EMAIL_SERVICE: Gmail
      EMAIL_USER: "trungductwice@gmail.com"
      EMAIL_PASSWORD: "eqcs qeyl nmqt bpnk"
      EMAIL_FROM: "E-Learning Platform <trungductwice@gmail.com>"
      GOOGLE_CALENDAR_ENABLED: "true"
      GOOGLE_CLIENT_ID: "560938395171-9o65cgu27oe1gkbhkm54kmegc73hu4h1.apps.googleusercontent.com"
      GOOGLE_CLIENT_SECRET: "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"
      GOOGLE_REDIRECT_URI: "http://3.107.5.21/auth/google/callback"
      USER_SERVICE_URL: "http://user-service:8080"
      SCHEDULE_SERVICE_URL: "http://schedule-service:8082"
      HOMEWORK_SERVICE_URL: "http://homework-service:8081"
      HOMEWORK_REMINDER_HOURS: "24"
      CLASS_REMINDER_MINUTES: "10"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 2
      placement:
        preferences:
          - spread: node.id

  client:
    image: trungduc14/client:latest
    environment:
      NODE_ENV: production
    ports:
      - "3000:80"
    networks:
      - e-learning-network
    deploy:
      <<: *restart_policy
      replicas: 1
      placement:
        preferences:
          - spread: node.id

volumes:
  redis_data:
    driver: local
  file_uploads:
    driver: local

networks:
  e-learning-network:
    driver: overlay
    attachable: true
